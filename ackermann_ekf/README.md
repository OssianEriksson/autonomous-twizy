# ackermann_ekf <!-- omit in toc -->

Extended Kalman filter for robot localization with a physical model based on the Ackermann geometry. This package is inspired by [robot_localization](http://docs.ros.org/en/noetic/api/robot_localization/html/index.html).


**Package Links**

* [Code API](https://ossianeriksson.github.io/autonomous-twizy/ackermann_ekf/html/index.html)

**Contents**

- [Filter Design](#filter-design)
  - [Coordinate Frames](#coordinate-frames)
    - [Global Frame](#global-frame)
    - [Local Frame](#local-frame)
  - [Euler Angles Conventions](#euler-angles-conventions)
  - [MATLAB](#matlab)
- [Nodes](#nodes)
  - [ackermann_ekf](#ackermann_ekf)
    - [Subscribed Topics](#subscribed-topics)
    - [Published Topics](#published-topics)
    - [Published Transforms](#published-transforms)
    - [Parameters](#parameters)

# Filter Design

The state vector is 11-dimensional:

[_X_ _Y_ _Z_ _ẋ_ _ẍ_ _Roll_ _Pitch_ _Yaw_ d<i>roll/</i>d<i>x</i> d<i>pitch/</i>d<i>x</i> d<i>yaw/</i>d<i>x</i>],

with the possibility to measure 15 variables:

[_X_ _Y_ _Z_ _ẋ_ _ẏ_ _ż_ _ẍ_ _ÿ_ _z̈_ _Roll_ _Pitch_ _Yaw_ d<i>roll/</i>d<i>t</i> d<i>pitch/</i>d<i>t</i> d<i>yaw/</i>d<i>t</i>]

where
* _x_, _y_, _z_ are position in global frame
* _ẋ_, _ẏ_, _ż_ are velocity in local farme
* _ẍ_, _ÿ_, _z̈_ are acceleration in local frame
* _Roll_, _Pitch_, _Yaw_ are rotation in global frame
* d<i>roll/</i>d<i>x</i>, d<i>pitch/</i>d<i>x</i>, d<i>yaw/</i>d<i>x</i> are derivatives of rotation in local frame with respect to forward position
* d<i>roll/</i>d<i>t</i>, d<i>pitch/</i>d<i>t</i>, d<i>yaw/</i>d<i>t</i> are derivatives of rotation in local frame with respect to time

## Coordinate Frames

### Global Frame

The global frame is the frame provided by the `~world_frame` parameter: A fixed "lab" reference frame.

### Local Frame

The local frame is the frame provided by the `~base_link` parameter: A frame fixed to the mobile base with the origin at it's center of rotation, x pointing forward, y to the left and z up.

## Euler Angles Conventions

The Euler angles _Roll_, _Pitch_, _Yaw_ are use fixed axis convention with rotation first applied around the x axis, then y, lastly z. 

## MATLAB

Code for state propagation and measurement functions is generated by the MATLAB script [ackermann_ekf.m](matlab/ackermann_ekf.m) where you can also find more details about the filter design.

# Nodes

## ackermann_ekf

Sensor fusion using Extended Kalman filter for vehicle localization. Publishes transforms and an odometry topic.

### Subscribed Topics

* `{~control_topic}` ([ackermann_msgs/AckermannDriveStamped](http://docs.ros.org/en/noetic/api/ackermann_msgs/html/msg/AckermannDriveStamped.html))  
  If the `~control_topic` parameter is specified, control signals to use for Kalman prediction step are subscribed to on this topic. Only speed and steering angle are currently used for prediction.

* `{~sensors[i]/topic}` (`{~sensors[i]/type}`)
  Sensor data stream to fuse. See the `~sensors` parameter for more information.

### Published Topics

* `odom` ([nav_msgs/Odometry](http://docs.ros.org/en/noetic/api/nav_msgs/html/msg/Odometry.html))  
  Current position, speed, rotation and anglular velocity as predicted by the EKF.

### Published Transforms

* `{~world_frame}` → `{~base_link}`

### Parameters

* `~frequency` (`double`, default: `30.0`)  
  Frequency to publish transforms and odometry at.

* `~world_frame` (`string`, default: `"map"`)  
  tf frame id of world frame.

* `~base_link` (`string`, default: `"base_link"`)  
  tf frame id of robot base: the center of rotation of the mobile base. For an Ackermann car this point would be centered on the rear axle. The x axis is assumed to be pointing forward, y to the left and z up.

* `~differential_position` (`bool`, default: `true`)  
  Whether to subtract the first measurement of absolute position from all subsequent measurements so the robot starts close to the origin in the `~world_frame`. If this parameter is true, the filter will not publish any transforms/odometry until a measurement of absolute position has been recieved.

* `~periodic_filter_time_delay` (`double`, default: `2.0/{~frequency}`)  
  Before odometry and transforms are published (when this happens is controlled by `~frequency`) the filter state is forced to update its state to a prediction for a time `~periodic_filter_time_delay` before the current ROS time if the filter time is not already ahead of this timestamp.

* `~x_max` (`list`, default: `[.inf, .inf, .inf, .inf, .inf, .inf, .inf, .inf, .inf, .inf, .inf]`)  
  Vector of maximum filter state components: The filter state is forcefully element wise upper bounded by this vector. Must have the same length as the filter state vector has dimensions.

* `~x_min` (`list`, default, `-{~x_max}`)  
  Vector of minimum filter state components: The filter state is forcefully element wise lower bounded by this vector. Must have the same length as the filter state vector has dimensions.
  
* `~zero_z` (`bool`, default: `false`)
  Wheter to set the z component of poisiton to zero in published transforms and odometry. The z component of the state vector will remain unaffected.

* `~control_topic` (`string`)  
  If set the node will subscribe to the topic whose name is `~control_topic` for collection on control signals for the vehicle. The control signals are then used in the Kalman prediction step.

* `~control_acceleration_gain` (`double`, default: `1.0`)  
  If `~control_topic` is set, in predicting acceleration from control velocity, this is the gain related to velocity error.

* `~max_control_acceleration` (`double`, default: `1.0`)  
  If `~control_topic` is set, in predicting acceleration from control velocity, this is the maximum allowed acceleration: Accelerations above (or below the negated value) will be clamped to this value.

* `~control_angle_speed_gain` (`double`, default: `1.0`)  
  If `~control_topic` is set, In predicting steering angle velocity from control steering angle, this is the gain related to steering angle error.

* `~max_control_angle_speed` (`double`, default: `1.0`)  
  If `~control_topic` is set, in predicting steering angle velocity from control steering angle, this is the maximum allowed steering angle velocity: Velocities above (or below the negated value) will be clamped to this value.

* `~sensors` (`list`)  
  List of sensors to fuse, see below for specification of list element parameters

  - `~sensors[i]/topic` (`string`, required)  
    Name of a topic where measurement messages will be published

  - `~sensors[i]/type` (`string`, required)  
    Message type of messages published on `~sensors[i]/topic`. Must be one of
    + `"sensor_msgs/NavSatFix"`
    + `"sensor_msgs/Imu"`
    + `"twizy_wheel_encoder/WheelEncoder"`
  
  - `~sensors[i]/mask` (`list`, default: All measurements supported by `~sensors[i]/type`)  
    Vector of booleans, same length as measurement vector. Each entry corresponds to the measurement compoenent at the same index in the measurement vector (see [Filter Design](#filter-design)). A value of `true` indicates that the measurement of the variable at this index should be fused into the filter state and ignored otherwise.

  - `~sensors[i]/gravity` (`double`, default: `9.82`)  
    Gravitational acceleration associated with the measurement (this value is e.g. subtracted from acceleration measurement).
